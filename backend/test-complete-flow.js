import pool from './db.js';

async function testCompleteFlow() {
  try {
    console.log('ğŸ”„ Testing complete resume flow...\n');
    
    const testUserId = 5; // srikari user
    console.log(`Testing with user_id: ${testUserId}`);
    
    // Test 1: Check user exists
    console.log('\n1ï¸âƒ£ Checking user...');
    const userResult = await pool.query('SELECT * FROM users WHERE user_id = $1', [testUserId]);
    if (userResult.rows.length === 0) {
      console.log('âŒ User not found');
      return;
    }
    console.log(`âœ… User found: ${userResult.rows[0].name} (${userResult.rows[0].email})`);
    
    // Test 2: Check job_seeker profile
    console.log('\n2ï¸âƒ£ Checking job_seeker profile...');
    const seekerResult = await pool.query('SELECT * FROM job_seekers WHERE user_id = $1', [testUserId]);
    if (seekerResult.rows.length === 0) {
      console.log('âš ï¸  No job_seeker profile, creating one...');
      await pool.query(\n        'INSERT INTO job_seekers (user_id, nationality, address) VALUES ($1, $2, $3)',\n        [testUserId, 'Indian', 'Hyderabad']\n      );\n      console.log('âœ… Job_seeker profile created');
    } else {\n      console.log('âœ… Job_seeker profile exists');\n    }\n    \n    // Test 3: Check resumes\n    console.log('\n3ï¸âƒ£ Checking resumes...');\n    const resumes = await pool.query('SELECT * FROM resumes WHERE seeker_id = (SELECT seeker_id FROM job_seekers WHERE user_id = $1)', [testUserId]);\n    console.log(`ğŸ“„ Found ${resumes.rows.length} resumes`);\n    resumes.rows.forEach((resume, index) => {\n      console.log(`  ${index + 1}. ${resume.title} (ID: ${resume.resume_id}) ${resume.is_primary ? '[PRIMARY]' : ''}`);\n    });\n    \n    // Test 4: Check resume data (skills, experiences, education)\n    if (resumes.rows.length > 0) {\n      const resumeId = resumes.rows[0].resume_id;\n      console.log(`\n4ï¸âƒ£ Checking data for resume ID ${resumeId}...`);\n      \n      const skills = await pool.query('SELECT * FROM skills WHERE resume_id = $1', [resumeId]);\n      console.log(`ğŸ”§ Skills: ${skills.rows.length} records`);\n      skills.rows.forEach(skill => {\n        console.log(`  - ${skill.skill_type}: ${skill.skills.join(', ')}`);\n      });\n      \n      const experiences = await pool.query('SELECT * FROM experiences WHERE resume_id = $1', [resumeId]);\n      console.log(`ğŸ’¼ Experiences: ${experiences.rows.length} records`);\n      experiences.rows.forEach(exp => {\n        console.log(`  - ${exp.job_title} at ${exp.company} (${exp.duration})`);\n      });\n      \n      const education = await pool.query('SELECT * FROM education WHERE resume_id = $1', [resumeId]);\n      console.log(`ğŸ“ Education: ${education.rows.length} records`);\n      education.rows.forEach(edu => {\n        console.log(`  - ${edu.qualification} from ${edu.college} (GPA: ${edu.gpa})`);\n      });\n    }\n    \n    // Test 5: Test API endpoints simulation\n    console.log('\n5ï¸âƒ£ Simulating API operations...');\n    \n    // Simulate resume builder save\n    const mockResumeData = {\n      personalInfo: {\n        name: 'John Doe',\n        email: 'john@test.com',\n        summary: 'Experienced software developer'\n      },\n      experience: [{\n        title: 'Software Engineer',\n        company: 'Tech Corp',\n        duration: '2020-2023',\n        description: 'Built web applications'\n      }],\n      education: [{\n        degree: 'B.Tech Computer Science',\n        school: 'Tech University',\n        year: '2020',\n        gpa: '8.5'\n      }],\n      skills: ['JavaScript', 'React', 'Node.js']\n    };\n    \n    console.log('ğŸ“ Testing resume builder simulation...');\n    \n    // Get or create resume\n    let resumeId;\n    if (resumes.rows.length === 0) {\n      const newResume = await pool.query(\n        'INSERT INTO resumes (seeker_id, title, statement_profile, is_primary) VALUES ((SELECT seeker_id FROM job_seekers WHERE user_id = $1), $2, $3, $4) RETURNING resume_id',\n        [testUserId, 'Test Resume', mockResumeData.personalInfo.summary, true]\n      );\n      resumeId = newResume.rows[0].resume_id;\n      console.log(`âœ… Created new resume ID: ${resumeId}`);\n    } else {\n      resumeId = resumes.rows[0].resume_id;\n      console.log(`âœ… Using existing resume ID: ${resumeId}`);\n    }\n    \n    // Clear existing data\n    await pool.query('DELETE FROM skills WHERE resume_id = $1', [resumeId]);\n    await pool.query('DELETE FROM experiences WHERE resume_id = $1', [resumeId]);\n    await pool.query('DELETE FROM education WHERE resume_id = $1', [resumeId]);\n    \n    // Add skills\n    try {\n      await pool.query(\n        'INSERT INTO skills (resume_id, skill_type, skills) VALUES ($1, $2, $3)',\n        [resumeId, 'tech', mockResumeData.skills]\n      );\n      console.log('âœ… Skills added successfully');\n    } catch (error) {\n      console.log('âŒ Skills failed:', error.message);\n    }\n    \n    // Add experience\n    try {\n      await pool.query(\n        'INSERT INTO experiences (resume_id, company, duration, job_title, description) VALUES ($1, $2, $3, $4, $5)',\n        [resumeId, mockResumeData.experience[0].company, mockResumeData.experience[0].duration, mockResumeData.experience[0].title, mockResumeData.experience[0].description]\n      );\n      console.log('âœ… Experience added successfully');\n    } catch (error) {\n      console.log('âŒ Experience failed:', error.message);\n    }\n    \n    // Add education\n    try {\n      await pool.query(\n        'INSERT INTO education (resume_id, qualification, college, gpa) VALUES ($1, $2, $3, $4)',\n        [resumeId, mockResumeData.education[0].degree, mockResumeData.education[0].school, mockResumeData.education[0].gpa]\n      );\n      console.log('âœ… Education added successfully');\n    } catch (error) {\n      console.log('âŒ Education failed:', error.message);\n    }\n    \n    // Final verification\n    console.log('\n6ï¸âƒ£ Final verification...');\n    const finalSkills = await pool.query('SELECT COUNT(*) FROM skills WHERE resume_id = $1', [resumeId]);\n    const finalExp = await pool.query('SELECT COUNT(*) FROM experiences WHERE resume_id = $1', [resumeId]);\n    const finalEdu = await pool.query('SELECT COUNT(*) FROM education WHERE resume_id = $1', [resumeId]);\n    \n    console.log(`ğŸ“Š Final counts:`);\n    console.log(`  - Skills: ${finalSkills.rows[0].count}`);\n    console.log(`  - Experiences: ${finalExp.rows[0].count}`);\n    console.log(`  - Education: ${finalEdu.rows[0].count}`);\n    \n    if (finalSkills.rows[0].count > 0 && finalExp.rows[0].count > 0 && finalEdu.rows[0].count > 0) {\n      console.log('\nğŸ‰ SUCCESS: Resume builder flow is working!');\n    } else {\n      console.log('\nâš ï¸  PARTIAL: Some data was not saved properly');\n    }\n    \n  } catch (error) {\n    console.error('âŒ Test failed:', error);\n  } finally {\n    process.exit(0);\n  }\n}\n\ntestCompleteFlow();